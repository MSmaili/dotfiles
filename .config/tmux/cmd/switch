#!/usr/bin/env bash

DIR="$(cd "$(dirname "$0")" && pwd)"
PREVIEW="$DIR/switch-preview.sh"

main() {
    result=$(muxie list sessions --windows --format=flat --marker '❯' | \
        fzf --height=100% --ansi --layout=reverse \
            --prompt="Session:Window › " \
            --border=sharp \
            --padding=0 \
            --margin=0 \
            --preview="$PREVIEW {1}" \
            --preview-window=right:70%:hidden \
            --exit-0 \
            --bind 'ctrl-x:execute-silent(tmux kill-session -t {1})+reload(muxie list sessions --windows --format=flat --marker "❯ ")'
    )

    [[ -z "$result" ]] && exit 0

    IFS=':' read -r session window <<< "$result"

    if [[ -n "$window" ]]; then
        # Switch to session first, then select window
        tmux switch-client -t "$session"
        tmux select-window -t "$session:$window"
    else
        tmux switch-client -t "$session"
    fi
}

main
